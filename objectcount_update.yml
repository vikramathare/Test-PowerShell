- name: playbook
  hosts: localhost
  tasks:
  - name: task-1
    kubernetes.core.k8s_info:
      api_version: vmpool-operator.slb.com/v1
      kind: PtsVmControl
      namespace: sandbox-vmpool-operator-system
    register: vms

  - name: task-2
    set_fact:
      vms_var: '{{ vms | json_query(query) }}'
    vars:
      query: "resources[?(@.spec.desired_vm_state == 'present' && 
                @.spec.desired_vm_status == 'running' && 
                @.spec.session_id == null && @.spec.orphan !=true)].spec.vm_name | length"

  # - name: task-3
  #   set_fact:
  #     current_num_hot_free_vms_var: '{{ vms_var | length }}'

  - name: task-2
    debug:
      msg:
      - 'vms_var: {{ vms_var }}'
